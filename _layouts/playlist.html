---
layout: default
---

{% assign playlist = page %}
{% assign all_songs = site.songs %}

{% assign first_song_id = playlist.songs | first %}
{% assign first_song = all_songs | where: "song_id", first_song_id | first %}

<div class="playlist-page">

  <!-- ============================
       PLAYLIST TITLE + NARRATIVE
  ============================= -->
  <h1 class="playlist-title">{{ playlist.title }}</h1>

  <!-- ============================
       DEBUG BLOCK (TEMPORARY)
  ============================= -->
  <div style="background:#222; color:#0ff; padding:1rem; margin:1rem 0; font-family:monospace; white-space:pre-wrap;">
<!-- ============================
     DEBUG BLOCK (TEMPORARY)
============================= -->
<div style="background:#111; color:#0ff; padding:1rem; margin:1rem 0; font-family:monospace; white-space:pre-wrap;">
<!-- ============================
     DEBUG BLOCK (TEMPORARY)
============================= -->
<div style="background:#111; color:#0ff; padding:1rem; margin:1rem 0; font-family:monospace; white-space:pre-wrap;">
  <strong>DEBUG:</strong>

  playlist.songs (quoted):
  {% for sid in playlist.songs %}
    - "[{{ sid }}]"
  {% endfor %}

  site.songs (song_id only):
  {% for s in site.songs %}
    - "[{{ s.song_id }}]"
  {% endfor %}

  first_song_id:
  "[{{ first_song_id }}]"

  {% assign first_url = "/music/" | append: first_song_id | append: "/" %}
  {% assign first_meta = site.data.music.songs | where: "url", first_url | first %}

  first_song youtube_id from music.yml:
  {% if first_meta %}
    "[{{ first_meta.youtube_id }}]"
  {% else %}
    "[NOT FOUND]"
  {% endif %}

carousel tracks (song_id + youtube_id + image from music.yml):
{% for sid in playlist.songs %}
  {% assign url = "/music/" | append: sid | append: "/" %}
  {% assign meta = site.data.music.songs | where: "url", url | first %}
  - song_id: "[{{ sid }}]"
    url: "[{{ url }}]"
    youtube_id: "[{% if meta %}{{ meta.youtube_id }}{% else %}NOT FOUND{% endif %}]"
    image: "[{% if meta %}{{ meta.image }}{% else %}NOT FOUND{% endif %}]"
{% endfor %}
</div>

  {% if playlist.description %}
    <p class="playlist-narrative">{{ playlist.description }}</p>
  {% endif %}

  <!-- ============================
       ACTIVE YOUTUBE PLAYER
  ============================= -->
  <div id="playlist-player" class="playlist-player">
    <iframe
      id="playlist-iframe"
      width="100%"
      height="360"
      {% assign first_url = "/music/" | append: first_song.song_id | append: "/" %}
      {% assign first_meta = site.data.music.songs | where: "url", first_url | first %}
      src="https://www.youtube.com/embed/{{ first_meta.youtube_id }}"
      frameborder="0"
      allowfullscreen>
    </iframe>
  </div>

  <!-- ============================
       PLAYLIST CAROUSEL
  ============================= -->
<div class="playlist-carousel" id="playlist-carousel">
  {% for song_id in playlist.songs %}
    {% assign song = all_songs | where: "song_id", song_id | first %}
    {% assign url = "/music/" | append: song.song_id | append: "/" %}
    {% assign meta = site.data.music.songs | where: "url", url | first %}

    <div class="playlist-tile {% if forloop.first %}active{% endif %}"
         data-song="{{ song.song_id }}">
      <img src="{{ meta.image }}" alt="{{ song.title }}">
      <h3>{{ song.title }}</h3>
    </div>
  {% endfor %}
</div>

  <!-- ============================
       DYNAMIC TRACK DETAILS
  ============================= -->
  <div id="song-details" class="song-details">
    <h2 id="song-title">{{ first_song.title }}</h2>
    <p id="song-description">{{ first_song.about }}</p>
    <div id="song-lyrics">
      {{ first_song.lyrics | markdownify }}
    </div>
  </div>

</div>

<!-- ============================
     SCRIPT: DYNAMIC TRACK SWITCHING
============================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  /* -----------------------------------------
     SAFE, ESCAPED SONG DATA (NO JSONIFY BUG)
  ----------------------------------------- */
  const allSongs = [
    {% for song in site.songs %}
      {
        song_id: "{{ song.song_id }}",
        title: {{ song.title | jsonify }},
        {% assign url = "/music/" | append: song.song_id | append: "/" %}
        {% assign meta = site.data.music.songs | where: "url", url | first %}
        youtube_id: "{{ meta.youtube_id }}",
        image: {{ song.image | jsonify }},
        description: {{ song.about | jsonify }},
        lyrics: {{ song.lyrics | jsonify }}
      }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ];

  const playlistSongs = {{ playlist.songs | jsonify }};

  const iframe = document.getElementById("playlist-iframe");
  const titleEl = document.getElementById("song-title");
  const descEl = document.getElementById("song-description");
  const lyricsEl = document.getElementById("song-lyrics");

  const tiles = document.querySelectorAll(".playlist-tile");

  function getSongData(id) {
    return allSongs.find(s => s.song_id === id);
  }

  tiles.forEach(tile => {
    tile.addEventListener("click", () => {
      const songId = tile.dataset.song;
      const song = getSongData(songId);

      if (!song) return;

      // Update active tile
      tiles.forEach(t => t.classList.remove("active"));
      tile.classList.add("active");

      // Update YouTube embed
      iframe.src = "https://www.youtube.com/embed/" + song.youtube_id;

      // Update details
      titleEl.textContent = song.title;
      descEl.textContent = song.description || "";
      lyricsEl.innerHTML = song.lyrics || "";

      // Smooth scroll to details
      document.getElementById("song-details").scrollIntoView({
        behavior: "smooth",
        block: "start"
      });
    });
  });

});
</script>

