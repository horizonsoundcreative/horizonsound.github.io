---
layout: default
---

{% comment %}
  1. Load the playlist entry from playlists.yml
{% endcomment %}

{% assign playlist = site.data.playlists | where: "playlist_id", page.playlist_id | first %}

<main class="playlist-page">
  <script>
    window.isPlaylistPage = true;
  </script>

  {% if site.debug %}
  <div class="debug-block">
    <pre style="background:#111; color:#0ff; padding:1rem; white-space:pre-wrap;">
      PLAYLIST PAGE DEBUG
      ==============================
      
      page.playlist_id: {{ page.playlist_id }}
      
      PLAYLIST YAML ENTRY:
      {{ playlist | jsonify }}
      
      SONG IDS FROM PLAYLIST:
      {{ playlist.songs | jsonify }}
    </pre>
  </div>
  {% endif %}

  <!-- PLAYLIST HEADER -->
  <section class="playlist-header">
    <h2 class="section-header">{{ playlist.title }}</h2>
    {% if playlist.description %}
    <p class="playlist-description">{{ playlist.description }}</p>
    {% endif %}
  </section>

  {% comment %}
    2. Build the list of songs for this playlist
  {% endcomment %}
  {% assign playlist_songs = "" | split: "" %}

  {% for sid in playlist.songs %}
    {% assign expected_song = site.data.music.songs | where: "song_id", sid | first %}
    {% assign song_page = site.pages | where: "song_id", sid | first %}
  
    {% if expected_song %}
      {% assign merged = expected_song | merge: song_page %}
      {% assign playlist_songs = playlist_songs | push: merged %}
    {% endif %}
  {% endfor %}
  
  {% comment %}
    3. Sort playlist songs by sequence if present
  {% endcomment %}

  {% assign sorted = playlist_songs | sort: "sequence" %}
  {% assign first_song = sorted | first %}

  <!-- ⭐ PLAYER FRAME WRAPPER (PURPLE THEME) ⭐ -->
  <div class="player-frame player-frame--purple">
  
    <!-- EMBED -->
    {% include embed.html youtube_id=first_song.youtube_id %}
  
    <!-- JS DATA -->
    <script>
      window.allSongs = {{ sorted | jsonify }};
    </script>

    {% include carousel.html playlist=sorted %}
  </div>

  <!-- ABOUT + LYRICS stay inside frame -->
  <section class="playlist-about">
    <div class="centered-column">
      <h2 class="section-header">About the Song</h2>
      <div id="playlist-about" class="playlist-about-text"></div>
    </div>
  </section>

  <section class="playlist-lyrics">
    <div class="lyrics-block">
      <h2 class="section-header">Lyrics</h2>
      <div id="playlist-lyrics" class="playlist-lyrics-text"></div>
    </div>
  </section>
  <!-- ⭐ END PLAYER FRAME ⭐ -->

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const aboutEl = document.getElementById("playlist-about");
      const lyricsEl = document.getElementById("playlist-lyrics");
    
      const first = window.allSongs[0];
      if (first) {
        aboutEl.innerHTML = first.description_html || "";
        lyricsEl.innerHTML = first.lyrics_html || "";
      }
    
      document.querySelectorAll(".carousel-tile").forEach(tile => {
        tile.addEventListener("click", () => {
    
          console.log("=== PLAYLIST TILE CLICKED ===");
          console.log("Tile element:", tile);
          console.log("dataset.song:", tile.dataset.song);
          console.log("window.allSongs:", window.allSongs);
    
          const id = tile.dataset.song;
          const song = window.allSongs.find(s => s.song_id === id);
    
          console.log("Matched song:", song);
    
          if (!song) {
            console.warn("NO SONG FOUND FOR ID:", id);
            return;
          }
    
          aboutEl.innerHTML = song.description || "";
          lyricsEl.innerHTML = song.lyrics || "";
    
          console.log("About/Lyrics updated.");
        });
      });
    });
  </script>
  
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      function initTileSelection() {
        const tiles = document.querySelectorAll(".carousel-tile, .playlist-tile");
    
        // Wait until tiles exist
        if (!tiles.length) {
          return requestAnimationFrame(initTileSelection);
        }
    
        // If no tile is active, activate the first one
        const alreadyActive = Array.from(tiles).some(t => t.classList.contains("active"));
        if (!alreadyActive) {
          tiles[0].classList.add("active");
        }
    
        // Center it
        tiles[0].scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
      }
    
      initTileSelection();
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const carousels = document.querySelectorAll("[data-carousel]");
    
      carousels.forEach(carousel => {
        const strip = carousel.querySelector("[data-strip]");
        if (!strip) return;
    
        function updateDebug() {
          const sw = strip.scrollWidth;
          const cw = strip.clientWidth;
          const sl = strip.scrollLeft;
          const canScroll = sw > cw;
    
          const swEl = carousel.querySelector("[data-debug-scrollwidth]");
          const cwEl = carousel.querySelector("[data-debug-clientwidth]");
          const slEl = carousel.querySelector("[data-debug-scrollleft]");
          const csEl = carousel.querySelector("[data-debug-canscroll]");
    
          if (swEl) swEl.textContent = sw;
          if (cwEl) cwEl.textContent = cw;
          if (slEl) slEl.textContent = sl;
          if (csEl) csEl.textContent = canScroll ? "YES" : "NO";
        }
    
        updateDebug();
        strip.addEventListener("scroll", updateDebug);
        carousel.addEventListener("carousel:refresh", updateDebug);
    
        const left = carousel.querySelector("[data-arrow='left']");
        const right = carousel.querySelector("[data-arrow='right']");
    
        if (left) {
          left.addEventListener("click", () => {
            strip.scrollBy({ left: -300, behavior: "smooth" });
            setTimeout(updateDebug, 300);
          });
        }
    
        if (right) {
          right.addEventListener("click", () => {
            strip.scrollBy({ left: 300, behavior: "smooth" });
            setTimeout(updateDebug, 300);
          });
        }
      });
    });
  </script>
 
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const aboutEl = document.getElementById("playlist-about");
      const lyricsEl = document.getElementById("playlist-lyrics");
    
      function initAboutLyrics() {
        if (!window.allSongs || !window.allSongs.length) {
          return requestAnimationFrame(initAboutLyrics);
        }
    
        const first = window.allSongs[0];
        aboutEl.innerHTML = first.description_html || "";
        lyricsEl.innerHTML = first.lyrics_html || "";
      }
    
      initAboutLyrics();
    });
  </script>
</main>
