<section class="homepage-section">

  {% assign first_item = include.items[0] %}

  {%- comment -%}
    MODE 1 — NEW RELEASES (songs, date only)
  {%- endcomment -%}
  {% if include.section == "new_releases" %}

    {% assign resolved = "" | split: "" %}

    {% for item in include.items %}
      {% assign s = site.data.music.songs | where: "song_id", item.id | first %}
      {% if s and s.videostatus == "Public" %}
        {% assign resolved = resolved | push:
          item | merge:
            title: s.title,
            image: s.image,
            url: s.url,
            published_at: s.published_at
        %}
      {% endif %}
    {% endfor %}

    {% assign sorted = resolved | sort: "published_at" | reverse %}

    <div class="tile-grid">
      {% for item in sorted %}
        <div class="tile debug-tile">
          <a href="{{ site.baseurl }}{{ item.url }}">
            <img src="{{ site.baseurl }}{{ item.image }}" alt="{{ item.title }}">
            <h3 class="tile-title">{{ item.title }}</h3>
          </a>

          <!-- DEBUG -->
          <div style="background:#ffdddd; padding:6px; margin-top:6px; font-size:12px; border:1px solid #cc0000;">
            <strong>DEBUG</strong><br>
            section: new_releases<br>
            title: {{ item.title }}<br>
            published_at: {{ item.published_at }}<br>
            index: {{ forloop.index }}<br>
          </div>
        </div>
      {% endfor %}
    </div>

  {%- comment -%}
    MODE 2 — SPOTLIGHT (songs, view count only)
  {%- endcomment -%}
  {% elsif include.section == "spotlight" %}

    {% assign resolved = "" | split: "" %}

    {% for item in include.items %}
      {% assign s = site.data.music.songs | where: "song_id", item.id | first %}
      {% if s and s.videostatus == "Public" %}
        {% assign resolved = resolved | push:
          item | merge:
            title: s.title,
            image: s.image,
            url: s.url,
            view_count: s.metadata.statistics.view_count
        %}
      {% endif %}
    {% endfor %}

    {% assign sorted = resolved | sort: "view_count" | reverse %}

    <div class="tile-grid">
      {% for item in sorted %}
        <div class="tile debug-tile">
          <a class="tile" href="{{ site.baseurl }}{{ item.url }}">
            <img src="{{ site.baseurl }}{{ item.image }}" alt="{{ item.title }}">
            <h3 class="tile-title">{{ item.title }}</h3>
          </a>

          <!-- DEBUG -->
          <div style="background:#ddeeff; padding:6px; margin-top:6px; font-size:12px; border:1px solid #0044aa;">
            <strong>DEBUG</strong><br>
            section: spotlight<br>
            title: {{ item.title }}<br>
            view_count: {{ item.view_count }}<br>
            index: {{ forloop.index }}<br>
          </div>
        </div>
      {% endfor %}
    </div>

  {%- comment -%}
    MODE 3 — COLLECTIONS (playlists)
  {%- endcomment -%}
  {% elsif include.section == "collections" %}

    {% assign active_playlists = "" | split: "" %}
    {% assign inactive_playlists = "" | split: "" %}

    {% for pl in site.data.playlists %}
      {% assign tile = include.items | where: "id", pl.playlist_id | first %}
      {% if tile %}

        {% assign has_public = false %}
        {% assign newest_public_date = nil %}
        {% assign soonest_scheduled_date = nil %}

        {% for sid in pl.songs %}
          {% assign s = site.data.music.songs | where: "song_id", sid | first %}
          {% if s %}
            {% if s.videostatus == "Public" %}
              {% assign has_public = true %}
              {% if newest_public_date == nil or s.published_at > newest_public_date %}
                {% assign newest_public_date = s.published_at %}
              {% endif %}
            {% elsif s.videostatus == "Scheduled" %}
              {% if soonest_scheduled_date == nil or s.published_at < soonest_scheduled_date %}
                {% assign soonest_scheduled_date = s.published_at %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {% assign playlist_image = site.baseurl | append: "/assets/thumbnails/playlist-" | append: pl.playlist_id | append: ".jpeg" %}

        {% assign pl = pl | merge:
          has_public: has_public,
          newest_public_date: newest_public_date,
          soonest_scheduled_date: soonest_scheduled_date,
          image: playlist_image
        %}

        {% if has_public %}
          {% assign active_playlists = active_playlists | push: pl %}
        {% else %}
          {% assign inactive_playlists = inactive_playlists | push: pl %}
        {% endif %}

      {% endif %}
    {% endfor %}

    {% assign active_playlists = active_playlists | sort: "newest_public_date" | reverse %}
    {% assign inactive_playlists = inactive_playlists | sort: "soonest_scheduled_date" %}

    <div class="tile-grid">

      {% for pl in active_playlists %}
        <div class="tile debug-tile">
          <a class="tile" href="{{ site.baseurl }}/music/playlists/{{ pl.playlist_id }}/">
            <img src="{{ pl.image }}" alt="{{ pl.title }}">
            <h3 class="tile-title">{{ pl.title }}</h3>
          </a>

          <!-- DEBUG -->
          <div style="background:#ddffdd; padding:6px; margin-top:6px; font-size:12px; border:1px solid #009900;">
            <strong>DEBUG</strong><br>
            section: collections<br>
            title: {{ pl.title }}<br>
            newest_public_date: {{ pl.newest_public_date }}<br>
            index: {{ forloop.index }}<br>
          </div>
        </div>
      {% endfor %}

      {% for pl in inactive_playlists %}
        <div class="tile coming-soon debug-tile">
          <img src="{{ pl.image }}" alt="{{ pl.title }}">
          <div class="tile-overlay">Coming Soon</div>
          <h3 class="tile-title">{{ pl.title }}</h3>

          <!-- DEBUG -->
          <div style="background:#ffeecc; padding:6px; margin-top:6px; font-size:12px; border:1px solid #cc8800;">
            <strong>DEBUG</strong><br>
            section: collections<br>
            title: {{ pl.title }}<br>
            soonest_scheduled_date: {{ pl.soonest_scheduled_date }}<br>
            index: {{ forloop.index }}<br>
          </div>
        </div>
      {% endfor %}

    </div>

  {% endif %}

</section>
