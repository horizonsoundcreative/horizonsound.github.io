---
layout: default
title: Music â€“ Horizon Sound
---

{% assign all_songs = site.data.music.songs | where: "videostatus", "Public" %}
{% assign playlists = all_songs | map: "primary_playlist" | uniq | reject: "" | sort %}

<div class="music-page">

  {% if site.debug %}
  <div class="debug-block">
  <pre style="background:#111; color:#0ff; padding:1rem; margin:1rem 0; white-space:pre-wrap;">
  
  MUSIC PAGE DEBUG
  ==============================
  
  PLAYLISTS (from all_songs):
  {{ playlists | jsonify }}
  
  ALL SONGS (public only):
  {{ all_songs | jsonify }}
  
  --- PER-PLAYLIST SORT CHECK ---
  {% for list in playlists %}
    Playlist: {{ list }}
    Songs in list:
    {% assign songs_in_list = all_songs | where: "primary_playlist", list %}
    {{ songs_in_list | jsonify }}
  
    Sorted by sequence:
    {% assign sorted_by_sequence = songs_in_list | sort: "sequence" %}
    {{ sorted_by_sequence | jsonify }}
  
    First item:
    {% assign first_item = sorted_by_sequence | first %}
    {{ first_item | jsonify }}
  
    Final playlist_sorted:
    {% if first_item.sequence %}
      {% assign playlist_sorted = sorted_by_sequence %}
    {% else %}
      {% assign playlist_sorted = songs_in_list | sort: "title" %}
    {% endif %}
    {{ playlist_sorted | jsonify }}
  
    --- URL â†’ song_id resolution test ---
    {% for item in playlist_sorted %}
      URL: {{ item.url }}
      Segments: {{ item.url | split: "/" | jsonify }}
      song_id: {{ item.url | split: "/" | slice: -2, 1 }}
    {% endfor %}
  
    -------------------------------
  {% endfor %}
  
  </pre>
  </div>
  {% endif %}
  
  
  <!-- VIEW TOGGLE -->
  <div class="view-toggle">
    <div class="view-toggle-buttons">
      <button class="view-toggle-button active" data-view="grouped">Grouped by Playlist</button>
      <button class="view-toggle-button" data-view="all">All Songs</button>
      <button class="view-toggle-button" data-view="carousel">Carousel View</button>
    </div>
  
    <h2 class="page-title">Music Catalog</h2>
  
    <div class="view-toggle-spacer"></div>
  </div>

  <!-- ------------------------------------------------
       VIEW 1: GROUPED BY PRIMARY PLAYLIST (DEFAULT)
  ------------------------------------------------- -->
  <section id="music-view-grouped">
  
    <!-- ============================
         PLAYLIST GRID (ALBUMS & ARCS)
    ============================= -->
    {% assign playlist_data = site.data.playlists | sort: "order" %}
    {% if playlist_data.size > 0 %}
    <section class="playlist-section music-collections">
      <h2 class="section-header">Collections</h2>
    
      <div class="tile-grid">
        {% for pl in playlist_data %}
          {% assign songs_in_list = all_songs | where: "primary_playlist", pl.title %}
          {% assign sorted_by_sequence = songs_in_list | sort: "sequence" %}
          {% assign first_item = sorted_by_sequence | first %}
    
          {% if first_item.sequence %}
            {% assign playlist_sorted = sorted_by_sequence %}
          {% else %}
            {% assign playlist_sorted = songs_in_list | sort: "title" %}
          {% endif %}
    
          {% assign first_song = playlist_sorted | first %}
          {% if first_song %}
            <a class="tile" href="/playlists/{{ pl.id }}/">
              <img src="{{ first_song.image }}" alt="{{ pl.title }}">
              <h3 class="tile-title">{{ pl.title }}</h3>
            </a>
          {% endif %}
        {% endfor %}
      </div>
    </section>
    {% endif %}
    
    <!-- ==========================================
         GENRE / PRIMARY PLAYLIST GROUPS (Existing)
         Excluding playlists already in playlist_data
    =========================================== -->
    {% assign playlist_names = playlist_data | map: "title" %}
   
    {% for list in playlists %}
      {% unless playlist_names contains list %}
        {% assign songs_in_list = all_songs | where: "primary_playlist", list %}
        {% assign sorted_by_sequence = songs_in_list | sort: "sequence" %}
        {% assign first_item = sorted_by_sequence | first %}
  
        {% if first_item.sequence %}
          {% assign playlist_sorted = sorted_by_sequence %}
        {% else %}
          {% assign playlist_sorted = songs_in_list | sort: "title" %}
        {% endif %}
  
        {% if playlist_sorted.size > 0 %}
        <section class="playlist-section">
          <h2 class="section-header">{{ list }}</h2>
  
          <div class="tile-grid">
            {% for song in playlist_sorted %}
              <a class="tile" href="{{ song.url }}">
                <img src="{{ song.image }}" alt="{{ song.title }}">
                <h3 class="tile-title">{{ song.title }}</h3>
              </a>
            {% endfor %}
          </div>
        </section>
        {% endif %}
      {% endunless %}
    {% endfor %}
  
  </section>

  <!-- ------------------------------------------------
       VIEW 2: ALL SONGS (FLAT TILE GRID)
  ------------------------------------------------- -->
  <section id="music-view-all" style="display:none;">
    <section class="playlist-section">
      <h2 class="section-header">All Songs</h2>

      {% assign all_sorted = all_songs | sort: "title" %}
      <div class="tile-grid">
        {% for song in all_sorted %}
          <a class="tile" href="{{ song.url }}">
            <img src="{{ song.image }}" alt="{{ song.title }}">
            <h3 class="tile-title">{{ song.title }}</h3>
          </a>
        {% endfor %}
      </div>
    </section>
  </section>

  <!-- ------------------------------------------------
       VIEW 3: CAROUSEL ROWS BY PLAYLIST
  ------------------------------------------------- -->
  <section id="music-view-carousel" style="display:none;">
    {% for list in playlists %}
      {% assign songs_in_list = all_songs | where: "primary_playlist", list %}
      {% assign sorted_by_sequence = songs_in_list | sort: "sequence" %}
      {% assign first_item = sorted_by_sequence | first %}

      {% if first_item.sequence %}
        {% assign playlist_sorted = sorted_by_sequence %}
      {% else %}
        {% assign playlist_sorted = songs_in_list | sort: "title" %}
      {% endif %}

      {% if playlist_sorted.size > 0 %}
      <section class="playlist-section">
        <h2 class="section-header">{{ list }}</h2>

        {% include carousel.html playlist=playlist_sorted %}

      </section>
      {% endif %}
    {% endfor %}
  </section>

</div> <!-- end .music-page -->

<!-- --------------------------------------------------
     SCRIPT: VIEW TOGGLE + CAROUSEL ROWS
-------------------------------------------------- -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  /* VIEW TOGGLE */
  const buttons = document.querySelectorAll(".view-toggle-button");
  const views = {
    grouped: document.getElementById("music-view-grouped"),
    all: document.getElementById("music-view-all"),
    carousel: document.getElementById("music-view-carousel"),
  };

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const view = btn.getAttribute("data-view");

      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      Object.keys(views).forEach(key => {
        views[key].style.display = (key === view) ? "" : "none";
      });

      // ðŸ”¹ When switching to carousel view, refresh all carousels
      if (view === "carousel") {
        const carousels = document.querySelectorAll("[data-carousel]");
        carousels.forEach(c => {
          c.dispatchEvent(new Event("carousel:refresh"));
        });
      }
    });
  });

  /* CAROUSEL ROWS */
  const carousels = document.querySelectorAll("[data-carousel]");

  carousels.forEach((carousel) => {
    const strip = carousel.querySelector("[data-strip]");
    const leftArrow = carousel.querySelector('[data-arrow="left"]');
    const rightArrow = carousel.querySelector('[data-arrow="right"]');

    if (!strip || !leftArrow || !rightArrow) return;

    const TILE_WIDTH = 180;
    const TILE_GAP = 16;
    const SCROLL_AMOUNT = TILE_WIDTH + TILE_GAP;

    function updateArrows() {
      const maxScroll = strip.scrollWidth - strip.clientWidth;
      const current = strip.scrollLeft;

      if (current <= 0) leftArrow.classList.add("disabled");
      else leftArrow.classList.remove("disabled");

      if (current >= maxScroll - 1) rightArrow.classList.add("disabled");
      else rightArrow.classList.remove("disabled");
    }

    leftArrow.addEventListener("click", () => {
      strip.scrollBy({ left: -SCROLL_AMOUNT, behavior: "smooth" });
    });

    rightArrow.addEventListener("click", () => {
      strip.scrollBy({ left: SCROLL_AMOUNT, behavior: "smooth" });
    });

    strip.addEventListener("scroll", updateArrows);

    // optional: keep this if you like, but it's no longer critical
    const images = strip.querySelectorAll("img");
    let loaded = 0;

    if (images.length === 0) {
      updateArrows();
    } else {
      images.forEach(img => {
        if (img.complete) {
          loaded++;
          if (loaded === images.length) updateArrows();
        } else {
          img.addEventListener("load", () => {
            loaded++;
            if (loaded === images.length) updateArrows();
          });
        }
      });
    }

    // ðŸ”¹ NEW: allow external refresh when view becomes visible
    carousel.addEventListener("carousel:refresh", updateArrows);
  });
}); 
</script>
