---
layout: default
---

{% assign current_song = page %}
{% assign url = current_song.url %}
{% assign meta = site.data.music.songs | where: "url", url | first %}

{%- comment -%}
BUILD PLAYLIST FOR CAROUSEL (old system)
{%- endcomment -%}
{% assign related = site.data.music.songs | where: "primary_playlist", meta.primary_playlist %}
{% assign related_public = related | where: "videostatus", "Public" %}
{% assign sorted_by_sequence = related_public | sort: "sequence" %}
{% assign first_item = sorted_by_sequence | first %}

{% if first_item.sequence %}
  {% assign playlist_sorted = sorted_by_sequence %}
{% else %}
  {% assign playlist_sorted = related_public | sort: "title" %}
{% endif %}

<main>
  <script>
    window.currentSongId = "{{ page.song_id }}";
  </script>
  <script>
    window.allSongs = {{ site.data.music.songs | jsonify }};
  </script>

  <!-- DEBUG BLOCK -->
{% if site.debug %}
<div class="debug-block">
  <pre style="background:#111; color:#0ff; padding:1rem; margin:1rem 0; white-space:pre-wrap;">

SONG PAGE DEBUG
==============================

PAGE OBJECT
-----------
page.url:          {{ current_song.url }}
page.title:        {{ current_song.title }}
page.song_id:      {{ current_song.song_id }}
page.youtube_id:   {{ current_song.youtube_id }}

META OBJECT (from music.yml)
----------------------------
{{ meta | jsonify }}

RESOLVED VALUES
---------------
resolved.title:     {{ current_song.title | default: meta.title }}
resolved.youtube_id: {{ current_song.youtube_id | default: meta.youtube_id }}
resolved.image:      {{ meta.image }}
resolved.primary_playlist: {{ meta.primary_playlist }}

PLAYLIST SORTED (final list for carousel)
-----------------------------------------
{{ playlist_sorted | jsonify }}

  </pre>
</div>
{% endif %}

  <!-- SONG TITLE -->
  <section class="song-header">
    <h2 class="section-header">
      {{ current_song.title | default: meta.title }}
    </h2>
    {% if current_song.subtitle %}
      <p class="song-subtitle">{{ current_song.subtitle }}</p>
    {% endif %}
  </section>

  <!-- ⭐ PLAYER FRAME WRAPPER STARTS HERE ⭐ -->
  <div class="player-frame player-frame--dark">

    <!-- EMBED SECTION -->
    {% assign resolved_youtube_id = current_song.youtube_id | default: meta.youtube_id %}
    {% include embed.html youtube_id=resolved_youtube_id %}

    <!-- CAROUSEL -->
    {% include carousel.html songs=playlist_sorted %}

  </div>
  <!-- ⭐ PLAYER FRAME WRAPPER ENDS HERE ⭐ -->

  <!-- ABOUT SECTION -->
  <section class="song-about">
    <div class="centered-column">
      <h2 class="section-header">About the Song</h2>
      <div class="song-description">
        {{ page.about | markdownify }}
      </div>
    </div>
  </section>

  <!-- LYRICS SECTION -->
  <section class="song-lyrics">
    <div class="lyrics-block">
      <h2 class="section-header">Lyrics</h2>
      {{ page.lyrics | markdownify }}
    </div>
  </section>
  
</main>

<!-- ORIGINAL SIMPLE CAROUSEL JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  console.log("isPlaylistPage:", window.isPlaylistPage);

  if (window.isPlaylistPage) {
    console.log("Skipping global song-page handler because this is a playlist page.");
    return;
  }

  console.log("Running global song-page handler.");

  const tiles = document.querySelectorAll(".carousel-tile, .playlist-tile");
  const iframe = document.querySelector(".video-wrapper iframe");

  console.log("Found tiles:", tiles);

  // -----------------------------
  // 1. CLICK HANDLERS
  // -----------------------------
  tiles.forEach(tile => {
    tile.addEventListener("click", () => {

      console.log("=== SONG PAGE TILE CLICKED ===");
      console.log("Tile element:", tile);
      console.log("dataset.song:", tile.dataset.song);

      const songId = tile.dataset.song;
      const song = window.allSongs?.find(s => s.song_id === songId);

      console.log("Matched song:", song);

      if (iframe && song?.youtube_id) {
        console.log("Updating iframe to:", song.youtube_id);
        iframe.src = "https://www.youtube.com/embed/" + song.youtube_id;
      } else {
        console.warn("Iframe update skipped — missing song or youtube_id");
      }

      tiles.forEach(t => t.classList.remove("active"));
      tile.classList.add("active");
      tile.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });

      console.log("Active tile applied.");
    });
  });

  // -----------------------------
  // 2. INITIAL SELECTION ON PAGE LOAD
  // -----------------------------
  console.log("Running initial selection logic…");

  let initialId = window.currentSongId;

  if (!initialId && tiles.length > 0) {
    initialId = tiles[0].dataset.song;
  }

  const initialTile = [...tiles].find(t => t.dataset.song === initialId);

  if (initialTile) {
    initialTile.classList.add("active");
    initialTile.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });

    const song = window.allSongs?.find(s => s.song_id === initialId);
    if (iframe && song?.youtube_id) {
      iframe.src = "https://www.youtube.com/embed/" + song.youtube_id;
    }
  }

});
</script>
